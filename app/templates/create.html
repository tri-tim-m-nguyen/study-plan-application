{% extends "base.html" %}

{% block head_scripts %}
  <script src="{{ url_for('static', filename='timetable.js') }}"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='timetable.css') }}">
  <script>
    let activityCount = 0;
    let focusedActivity = null;

    function getRandomColor() {
      const letters = '0123456789ABCDEF';
      let color = '#';
      for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }

    function addActivity() {
        if (activityCount >= 10) return;

        activityCount += 1;
        const activityId = 'Activity' + activityCount;

        const activityBox = document.createElement('div');
        activityBox.classList.add('activity-box');

        const deleteIcon = document.createElement('img');
        deleteIcon.src = 'https://cdn-icons-png.flaticon.com/512/1214/1214428.png'; // red bin icon
        deleteIcon.alt = 'Delete';
        deleteIcon.className = 'delete-icon';
        deleteIcon.title = 'Delete activity';
        deleteIcon.onclick = () => {
            activityBox.remove();
            activityCount -= 1;
            // Show add button again if below limit
            if (activityCount < 10) {
            document.getElementById('add-button').style.display = 'inline-block';
            }
        };

        const activityText = document.createElement('div');
        activityText.className = 'activity-text';
        activityText.contentEditable = false;
        activityText.textContent = activityId;

        const colorBox = document.createElement('div');
        colorBox.className = 'activity-color-box';
        colorBox.style.backgroundColor = getRandomColor();

        const colorInput = document.createElement('input');
        colorInput.type = 'color';
        colorInput.className = 'hidden-color-input';

        colorBox.onclick = () => {
            colorInput.click();
        };

        colorInput.addEventListener('input', () => {
            colorBox.style.backgroundColor = colorInput.value;
        });

        // Focus on activity box on click
        activityBox.addEventListener('click', (e) => {
            // Prevent triggering when clicking on delete icon, color box or color input
            if (e.target === deleteIcon || e.target === colorBox || e.target === colorInput) return;
            
            if (focusedActivity === activityBox) {
                // Remove focus if clicked again
                focusedActivity = null;
                activityBox.classList.remove('focused');
            } else {
                // Set focus
                if (focusedActivity) {
                    focusedActivity.classList.remove('focused'); // Remove class from previously focused activity
                }
                focusedActivity = activityBox;
                activityBox.classList.add('focused'); // Add class to indicate focus
            }
        });

        activityText.addEventListener('dblclick', () => {
            activityText.contentEditable = true;
            activityText.focus();
        });
        activityText.addEventListener('blur', () => {
            activityText.contentEditable = false;
        });

        activityBox.appendChild(activityText);
        activityBox.appendChild(deleteIcon);
        activityBox.appendChild(colorBox);
        activityBox.appendChild(colorInput);


        const container = document.getElementById('activity-container');
        const addButton = document.getElementById('add-button');
        container.insertBefore(activityBox, addButton);

        if (activityCount === 10) {
            addButton.style.display = 'none';
        }
    }

    // Add event listener for cell clicks in timetable
    document.addEventListener("DOMContentLoaded", function () {
        const timeslots = document.querySelectorAll(".timeslot");

        timeslots.forEach(function (slot) {
            slot.addEventListener("click", function () {
                if (focusedActivity) {
                    const activityColor = focusedActivity.querySelector('.activity-color-box').style.backgroundColor; // Get the color of the focused activity
                    slot.style.backgroundColor = activityColor; // Fill the clicked cell with the color
                }
            });
        });
        document.getElementById('add-button').addEventListener('click', addActivity);
    });
  </script>
{% endblock %}

{% block content %}

<div class="row">
  {% include 'timetable.html' %}
  <div class="col-md-4">
    <button class="toggle" id="toggle-selected">Fully Unavailable</button>
    
    <button class="toggle" id="toggle-pselected">Partially Unavailable</button>

    <form>
      <div class="assessment-form">
        <label for="assessment-name">Assessment Name</label>
        <input type="text" id="name" name="name" class="form-control" placeholder="Enter assessment name" required>
      </div>
      <div class="assessment-form">
        <label for="assessment-date">Due Date</label>
        <input type="date" id="date" name="date" class="form-control" required>
      </div>
      <button type="submit">Submit</button>
    </form>

    <div id="activity-container">
        <!-- New activities will be added here -->
        <button id="add-button">+</button>
    </div>

  </div>
</div>
{% endblock %}
